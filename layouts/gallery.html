{{ define "title" }}{{ .Title }} | {{ .Site.Title }}{{ end }}

{{ define "main" }}
<div class="container">
  <header class="page-header">
    <h1>{{ .Title }}</h1>
    <p class="lead">{{ .Param "description" | default .Summary }}</p>
    <div class="gallery-filters">
      <div class="filter-group filter-group--search">
        <input type="search" id="search-filter" class="search-filter" placeholder="Pesquisar Pok√©mon..." aria-label="Pesquisar por nome" autocomplete="off">
      </div>
      <div class="filter-dropdown">
        <button type="button" id="filter-toggle" class="btn btn-filter" aria-expanded="false" aria-controls="filter-panel">
          <svg class="filter-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>
          Filtros
        </button>
        <div id="filter-panel" class="filter-panel" hidden>
          <div class="filter-panel__group">
            <label for="gen-filter" class="filter-label">Gera√ß√£o</label>
            <select id="gen-filter" class="gen-filter" aria-label="Filtrar por gera√ß√£o">
              <option value="1" selected>Gera√ß√£o 1 (Kanto)</option>
              <option value="2">Gera√ß√£o 2 (Johto)</option>
              <option value="3">Gera√ß√£o 3 (Hoenn)</option>
              <option value="4">Gera√ß√£o 4 (Sinnoh)</option>
              <option value="5">Gera√ß√£o 5 (Unova)</option>
              <option value="6">Gera√ß√£o 6 (Kalos)</option>
              <option value="7">Gera√ß√£o 7 (Alola)</option>
              <option value="8">Gera√ß√£o 8 (Galar)</option>
              <option value="9">Gera√ß√£o 9 (Paldea)</option>
            </select>
          </div>
          <div class="filter-panel__group">
            <label for="state-filter" class="filter-label">Estado</label>
            <select id="state-filter" class="gen-filter" aria-label="Filtrar por estado">
              <option value="all">Todos</option>
              <option value="done">J√° feitos</option>
              <option value="soon">Em breve</option>
            </select>
          </div>
          <div class="filter-panel__group">
            <label for="sort-filter" class="filter-label">Ordem</label>
            <select id="sort-filter" class="gen-filter" aria-label="Ordenar">
              <option value="done-first">Feitos primeiro</option>
              <option value="number">N√∫mero</option>
            </select>
          </div>
        </div>
      </div>
    </div>
  </header>

  <div class="pokemon-grid">
    {{ $whatsapp := .Site.Params.whatsapp_number }}
    {{ range site.Data.pokemon }}
      {{ $id := int .id }}
      {{ $gen := cond (ge $id 906) 9 (cond (ge $id 810) 8 (cond (ge $id 722) 7 (cond (ge $id 650) 6 (cond (ge $id 494) 5 (cond (ge $id 387) 4 (cond (ge $id 252) 3 (cond (ge $id 152) 2 1))))))) }}
      {{ $imgPath := printf "%03d/1.jpg" $id }}
      {{ $imgURL := $imgPath | absURL }}
      {{ $hasImage := eq .image true }}
      {{ $available := eq .available true }}
      {{ $isDone := or $hasImage $available }}

      <article class="pokemon-card {{ if not $hasImage }}pokemon-card--placeholder{{ end }}" data-generation="{{ $gen }}" data-name="{{ lower .name }}" data-done="{{ if $isDone }}true{{ else }}false{{ end }}" data-id="{{ $id }}">
        <div class="pokemon-card__media">
          {{ if $hasImage }}
            <img src="{{ $imgURL }}" alt="{{ .name }}" class="pokemon-card__img" loading="lazy" onerror="this.style.display='none';this.nextElementSibling.style.display='flex';">
            <div class="pokemon-card__placeholder pokemon-card__placeholder--fallback" style="display:none" aria-hidden="true">
              <span class="pokemon-card__silhouette"></span>
              <span class="pokemon-card__name-placeholder">{{ .name }}</span>
            </div>
            <span class="badge badge--done">J√° feito</span>
          {{ else }}
            <div class="pokemon-card__placeholder" aria-hidden="true">
              <span class="pokemon-card__silhouette"></span>
              <span class="pokemon-card__name-placeholder">{{ .name }}</span>
            </div>
            {{ if $available }}
              <span class="badge badge--available">Dispon√≠vel</span>
            {{ else }}
              <span class="badge badge--soon">Em breve</span>
            {{ end }}
          {{ end }}
        </div>
        <div class="pokemon-card__body">
          <div class="pokemon-card__header">
            <h2 class="pokemon-card__title">{{ .name }}</h2>
            <span class="pokemon-card__price {{ if not (or .price .valor) }}pokemon-card__price--tbd{{ end }}">
              {{ if .price }}{{ .price }}{{ else }}{{ if .valor }}{{ .valor }}{{ else }}Valor a definir{{ end }}{{ end }}
            </span>
          </div>
          <p class="pokemon-card__id">#{{ printf "%03d" $id }}</p>
          <a href="https://wa.me/{{ $whatsapp }}?text=Ol√°! Vi o Pok√©mon {{ .name }} no teu site üôÇ" class="btn btn-whatsapp" target="_blank" rel="noopener">Contactar no WhatsApp</a>
        </div>
      </article>
    {{ end }}
  </div>

  {{ .Content }}
</div>

<script>
(function() {
  // Filter panel toggle
  var toggleBtn = document.getElementById('filter-toggle');
  var panel = document.getElementById('filter-panel');
  if (toggleBtn && panel) {
    toggleBtn.addEventListener('click', function() {
      var isOpen = !panel.hidden;
      panel.hidden = isOpen;
      toggleBtn.setAttribute('aria-expanded', !isOpen);
      toggleBtn.classList.toggle('btn-filter--active', !isOpen);
    });
    document.addEventListener('click', function(e) {
      if (!panel.hidden && !panel.contains(e.target) && !toggleBtn.contains(e.target)) {
        panel.hidden = true;
        toggleBtn.setAttribute('aria-expanded', 'false');
        toggleBtn.classList.remove('btn-filter--active');
      }
    });
  }

  var select = document.getElementById('gen-filter');
  var search = document.getElementById('search-filter');
  var stateSelect = document.getElementById('state-filter');
  var sortSelect = document.getElementById('sort-filter');
  var grid = document.querySelector('.pokemon-grid');
  if (!select || !grid) return;
  var cards = Array.from(grid.querySelectorAll('.pokemon-card'));
  function filter() {
    var gen = select.value;
    var state = stateSelect ? stateSelect.value : 'all';
    var sort = sortSelect ? sortSelect.value : 'done-first';
    var q = (search && search.value) ? search.value.trim().toLowerCase() : '';
    var visible = [];
    var hidden = [];
    cards.forEach(function(card) {
      var matchGen = q || card.getAttribute('data-generation') === gen;
      var matchSearch = !q || (card.getAttribute('data-name') || '').indexOf(q) !== -1;
      var done = card.getAttribute('data-done') === 'true';
      var matchState = state === 'all' || (state === 'done' && done) || (state === 'soon' && !done);
      if (matchGen && matchSearch && matchState) {
        visible.push(card);
      } else {
        hidden.push(card);
      }
    });
    visible.sort(function(a, b) {
      var aId = parseInt(a.getAttribute('data-id') || '0');
      var bId = parseInt(b.getAttribute('data-id') || '0');
      if (sort === 'done-first') {
        var aDone = a.getAttribute('data-done') === 'true';
        var bDone = b.getAttribute('data-done') === 'true';
        if (aDone !== bDone) return aDone ? -1 : 1;
      }
      return aId - bId;
    });
    visible.forEach(function(card) {
      card.style.display = '';
      grid.appendChild(card);
    });
    hidden.forEach(function(card) {
      card.style.display = 'none';
      grid.appendChild(card);
    });
  }
  filter();
  select.addEventListener('change', filter);
  if (stateSelect) stateSelect.addEventListener('change', filter);
  if (sortSelect) sortSelect.addEventListener('change', filter);
  if (search) {
    search.addEventListener('input', filter);
    search.addEventListener('search', filter);
  }
})();
</script>
{{ end }}


